name: Build sgl-kernel
on:
  workflow_dispatch:

jobs:
  build-torch212-cu121:
    runs-on: ubuntu-latest
    steps:
      - name: Free up disk space
        run: |
          echo "Initial disk space:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          echo "Disk space after cleanup:"
          df -h

      - uses: actions/checkout@v4

      - name: Add swap space
        run: |
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          sudo swapon --show
      
      - name: Build wheel
        env:
          TORCH_CUDA_ARCH_LIST: "8.9"
        run: |
          docker run --rm -i \
            -v "${GITHUB_WORKSPACE}":/io \
            -w /io \
            pytorch/manylinux-builder:cuda12.1 \
            bash -c '
              set -euxo pipefail
              exec > >(tee /io/build.log) 2>&1
              
              echo "=== Find Python 3.10 ==="
              PYBIN=$(ls -d /opt/python/cp310-*/bin 2>/dev/null | head -n1)
              test -n "$PYBIN" || { echo "ERROR: Python 3.10 not found"; exit 1; }
              PY="$PYBIN/python"
              PIP="$PYBIN/pip"
              $PY --version
              
              echo "=== Fix pyproject.toml ==="
              sed -i "s/wheel.py-api.*=.*\"cp39\"/wheel.py-api = \"cp310\"/g" pyproject.toml
              grep "wheel.py-api" pyproject.toml
              
              echo "=== Install PyTorch 2.1.2 ==="
              $PIP install --no-cache-dir \
                --index-url https://download.pytorch.org/whl/cu121 \
                torch==2.1.2 2>&1 | tail -20
              
              echo "=== Install build tools ==="
              $PIP install --no-cache-dir cmake setuptools wheel scikit-build-core
              
              echo "=== Clean previous builds ==="
              rm -rf build _skbuild dist *.egg-info
              mkdir -p /io/dist
              
              echo "=== Build wheel ==="
              export TORCH_CUDA_ARCH_LIST="8.9"
              export CMAKE_GENERATOR="Unix Makefiles"
              export MAKEFLAGS="-j1"
              
              $PY -m pip wheel . \
                --no-deps \
                --no-build-isolation \
                --wheel-dir /io/dist \
                -vv
              
              echo "=== Build completed ==="
              ls -lh /io/dist/
            '
      
      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: sgl-kernel-torch212-cu121-sm89
          path: dist/*.whl
        
      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build*.log

